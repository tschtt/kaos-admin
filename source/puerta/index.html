---
layout: "base.njk"
title: "Kaos Produccion | Puerta"
---

<main>
    <h1 class="text-center">
        Puerta
    </h1>
    <!-- Search -->
    <form>
        <label for="name">Nombre</label>
        <input id="search" name="name" type="text" class="input" autocomplete="off">
    </form>
    <!-- Tickets pendientes -->
    <h2 class="text-300">Pendientes</h2>
    <ul id="ticket-pending-list"></ul>
    <!-- Tickets usados -->
    <h2 class="text-300">Adentro</h2>
    <ul id="ticket-used-list"></ul>
    <!-- Acciones -->
    <h2 class="text-300">Acciones</h2>
    <nav class="puerta-actions">
        <button class="text-left">Mostró comprobante</button>
        <button class="text-left">Pagó en puerta (transferencia)</button>
        <button class="text-left">Pagó en puerta (efectivo)</button>
    </nav>
    <dialog id="ticket-pending-dialog">
        <h2 class="dialog-title text-500 text-center capitalize">
            Marcar ingreso
        </h2>
        <p class="text-center">
            Se marcará el ingreso de la persona al evento
        </p>
        <div class="dialog-actions">
            <button id="ticket-pending-dialog-submit" class="dialog-button" type="submit" autofocus>
                ACEPTAR
            </button>
            <button id="ticket-pending-dialog-cancel" class="dialog-button" type="submit" value="cancel" autofocus>
                CANCELAR
            </button>
        </div>
    </dialog>
    <dialog id="ticket-used-dialog">
        <h2 class="dialog-title text-500 text-center capitalize">
            Revertir ingreso
        </h2>
        <p class="text-center">
            Se volverá a marcar a la persona como pendiente.
        </p>
        <div class="dialog-actions">
            <button id="ticket-used-dialog-submit" class="dialog-button" type="submit" autofocus>
                ACEPTAR
            </button>
            <button id="ticket-used-dialog-cancel" class="dialog-button" type="submit" value="cancel" autofocus>
                CANCELAR
            </button>
        </div>
    </dialog>
</main>
<script type="module">
    import { request, refresh_session } from '/_scripts/request.js'

    // helpers

    function wrapper(listener) {
        return async function (event) {
            try {
                await listener(event)
            } catch (error) {
                on_error(error)
            }
        }
    }
    
    function on_error(error) {
        console.log(error)
    }
    
    // constants
    
    const STATUSES = {
        ACTIVE: 1,
        BLOCKED: 2,
        USED: 3,
    }
    
    // elements
    
    const $search = document.querySelector('#search')
    
    const $ticket_pending_list = document.querySelector('#ticket-pending-list')
    const $ticket_pending_dialog = document.querySelector('#ticket-pending-dialog')
    const $ticket_pending_dialog_submit = document.querySelector('#ticket-pending-dialog-submit')
    const $ticket_pending_dialog_cancel = document.querySelector('#ticket-pending-dialog-cancel')
    
    const $ticket_used_list = document.querySelector('#ticket-used-list')
    const $ticket_used_dialog = document.querySelector('#ticket-used-dialog')
    const $ticket_used_dialog_submit = document.querySelector('#ticket-used-dialog-submit')
    const $ticket_used_dialog_cancel = document.querySelector('#ticket-used-dialog-cancel')
    
    // state

    let tickets = []
    let batches = []
    let selected
    
    // getters

    function get_tickets() {
        return tickets
    }

    function get_batches() {
        return batches
    }

    function get_selected() {
        return selected
    }

    function get_search() {
        return $search.value
    }

    // setters

    function set_tickets(value) {
        tickets = value
        return tickets
    }

    function set_batches(value) {
        batches = value
        return batches
    }

    function set_search(value) {
        $search.value = value
        return $search.value
    }

    function set_selected(value) {
        selected = value
        return selected
    }
    
    // requests
    
    async function request_batches() {
        return request({ url: '/batches', method: 'GET' })
    }
    
    async function request_tickets() {
        return request({ url: '/tickets', method: 'GET' })
    }

    async function request_ticket_update(id, data) {
        return request({ url: `/tickets/${id}`, method: 'PATCH', body: data })
    }
    
    async function request_ticket_creation(data) {
        return request({ url: '/tickets', method: 'POST', body: data })
    }
    
    // filters 

    function filter_tickets(tickets = [], value) {
        return tickets.filter(ticket => ticket.person.name.toLowerCase().includes(value.toLowerCase()))
    }
    
    // renders
    
    function render_tickets(tickets = []) {
        const tickets_pending = tickets.filter(ticket => ticket.fk_ticket_status === STATUSES.ACTIVE)
        const tickets_used = tickets.filter(ticket => ticket.fk_ticket_status === STATUSES.USED)
        
        if(!tickets_pending.length) {
            $ticket_pending_list.innerHTML = `
                <li class="button text-center">Sin resultados</li>
            `
        } else {
            $ticket_pending_list.innerHTML = tickets_pending.map(ticket => {
                return `
                <li>
                    <button class="ticket ticket-pending text-left capitalize" data-ticket="${ticket.id}" data-ticket-state="${ticket.fk_ticket_state}">
                        ${ ticket.person.name.toLowerCase() }
                    </button>
                </li>
                `
            }).join('')
        }
        
        if(!tickets_used.length) {
            $ticket_used_list.innerHTML = `
                <li class="button text-center">Sin resultados</li>
            `
        } else {
            $ticket_used_list.innerHTML = tickets_used.map(ticket => {
                return `
                <li>
                    <button class="ticket ticket-used text-left capitalize" data-ticket="${ticket.id}" data-ticket-state="${ticket.fk_ticket_state}">
                        ${ ticket.person.name.toLowerCase() }
                    </button>
                </li>
                `
            }).join('')
        }
    
    }
    
    // events
    
    function on_search(event) {
        let tickets, search
        search = get_search()
        tickets = get_tickets()
        tickets = filter_tickets(tickets, search)
        render_tickets(tickets)
    }


    function on_ticket_pending_click(event) {
        if(!event.target.className.includes('ticket-pending')) return
        const selected = tickets.find(ticket => ticket.id == event.target.dataset.ticket)
        const batch = batches.find(batch => batch.id == selected.fk_batch)
        set_selected(selected)
        $ticket_pending_dialog.querySelector('.dialog-title').innerHTML = selected.person.name
        $ticket_pending_dialog.querySelector('.dialog-button').setAttribute('value', selected.id)
        $ticket_pending_dialog.showModal()
    }

    async function on_ticket_pending_dialog_submit(event) {
        let selected, tickets, search
        selected = get_selected()
        search = get_search()
        await request_ticket_update(selected.id, { fk_ticket_status: STATUSES.USED })
        tickets = set_tickets(await request_tickets())
        tickets = filter_tickets(tickets, search)
        render_tickets(tickets)
        $ticket_pending_dialog.close()
    }

    async function on_ticket_pending_dialog_cancel(event) {
        $ticket_pending_dialog.close()
    }
    

    function on_ticket_used_click(event) {
        if(!event.target.className.includes('ticket-used')) return
        const selected = tickets.find(ticket => ticket.id == event.target.dataset.ticket)
        const batch = batches.find(batch => batch.id == selected.fk_batch)
        set_selected(selected)
        $ticket_used_dialog.querySelector('.dialog-title').innerHTML = selected.person.name
        $ticket_used_dialog.querySelector('.dialog-button').setAttribute('value', selected.id)
        $ticket_used_dialog.showModal()
    }

    async function on_ticket_used_dialog_submit(event) {
        let selected, tickets, search
        selected = get_selected()
        search = get_search()
        await request_ticket_update(selected.id, { fk_ticket_status: STATUSES.ACTIVE })
        tickets = set_tickets(await request_tickets())
        tickets = filter_tickets(tickets, search)
        render_tickets(tickets)
        $ticket_used_dialog.close()
    }      
    
    async function on_dialog_used_dialog_cancel(event) {
        $ticket_used_dialog.close()
    }
    

    async function on_init() {
        let tickets, batches, search
        await refresh_session()
        search = get_search()
        batches = set_batches(await request_batches())
        tickets = set_tickets(await request_tickets())
        tickets = filter_tickets(tickets, search)
        render_tickets(tickets)
    }

    // init

    $search.addEventListener('input', on_search)

    $ticket_pending_list.addEventListener('click', wrapper(on_ticket_pending_click))
    $ticket_pending_dialog_submit.addEventListener('click', wrapper(on_ticket_pending_dialog_submit))  
    $ticket_pending_dialog_cancel.addEventListener('click', wrapper(on_ticket_pending_dialog_cancel))  
    
    $ticket_used_list.addEventListener('click', wrapper(on_ticket_used_click))
    $ticket_used_dialog_submit.addEventListener('click', wrapper(on_ticket_used_dialog_submit))
    $ticket_used_dialog_cancel.addEventListener('click', wrapper(on_dialog_used_dialog_cancel))
    
    on_init().catch(on_error)

</script>
<style>
    dialog {
        /* border: none; */
        box-shadow: 1px 1px 10px black;
        padding: 1rem;
    }
    dialog > * + * {
        margin-top: 1rem;
    }
</style>